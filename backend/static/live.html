<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <title>Sepolia Explorer - Live</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>
    <style>
        body { font-family: 'Roboto', sans-serif; background-color: #111827; color: #e5e7eb; }
        
        /* Etherscan Table Styling */
        .es-table th { font-size: 0.75rem; font-weight: 700; color: #9ca3af; text-transform: uppercase; padding: 0.75rem; border-bottom: 1px solid #374151; }
        .es-table td { font-size: 0.875rem; padding: 0.75rem; border-bottom: 1px solid #1f2937; white-space: nowrap; vertical-align: middle; }
        .es-link { color: #60a5fa; text-decoration: none; cursor: pointer; transition: color 0.2s; }
        .es-link:hover { color: #93c5fd; text-decoration: underline; }
        
        .es-card { background-color: #1f2937; border: 1px solid #374151; border-radius: 0.5rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        
        /* Animations & Layout */
        .view-section { display: none; }
        .view-section.active { display: block; animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .animate-flash { animation: flash 1s ease-out; }
        @keyframes flash { 0% { background-color: rgba(59, 130, 246, 0.15); } 100% { background-color: transparent; } }

        /* Detail Label/Value */
        .dt-row { display: flex; padding: 12px 0; border-bottom: 1px solid #374151; align-items: center; }
        .dt-label { width: 25%; min-width: 150px; color: #9ca3af; font-size: 0.9rem; display: flex; align-items: center; gap: 6px; }
        .dt-val { font-family: monospace; color: #f3f4f6; font-size: 0.9rem; word-break: break-all; flex-grow: 1; }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #111827; }
        ::-webkit-scrollbar-thumb { background: #374151; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #4b5563; }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <header class="bg-[#111827] border-b border-gray-800 sticky top-0 z-50">
        <nav class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-2 cursor-pointer" onclick="showHome()">
                <div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center font-bold text-white text-sm">S</div>
                <span class="font-semibold text-lg tracking-tight text-white">Sepolia<span class="font-light">Scan</span></span>
            </div>
            <div class="flex space-x-6 text-sm font-medium">
                <a href="/" class="text-gray-400 hover:text-white transition">Dashboard</a>
                <a href="/activity" class="text-gray-400 hover:text-white transition">Predicted History</a>
                <span class="text-blue-400 border-b-2 border-blue-400 pb-0.5">Live Explorer</span>
            </div>
        </nav>
    </header>

    <main class="container mx-auto px-4 py-8 flex-grow max-w-7xl">
        
        <div class="bg-[#1e293b] p-1.5 rounded-lg flex items-center max-w-3xl mb-10 border border-gray-700 mx-auto shadow-lg">
            <div class="pl-3 pr-3 text-gray-400">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
            </div>
            <input type="text" id="main-search" placeholder="Search by Address / Txn Hash / Block" 
                   class="w-full bg-transparent border-none focus:ring-0 text-sm py-2 text-gray-200 placeholder-gray-500"
                   onkeypress="if(event.key === 'Enter') handleSearch()">
            <button onclick="handleSearch()" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded-md text-sm font-medium transition">
                Search
            </button>
        </div>

        <div id="view-feed" class="view-section active">
            <div class="es-card overflow-hidden">
                <div class="px-5 py-4 border-b border-gray-700 flex justify-between items-center bg-[#1f2937]">
                    <h3 class="text-base font-medium text-white">Latest Transactions</h3>
                    <div class="flex items-center gap-2">
                        <div class="relative flex h-3 w-3">
                          <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                          <span class="relative inline-flex rounded-full h-3 w-3 bg-green-500"></span>
                        </div>
                        <span class="text-xs text-gray-400 font-mono" id="connection-status">CONNECTING...</span>
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse es-table">
                        <thead class="bg-gray-800/50">
                            <tr>
                                <th class="w-32">Txn Hash</th>
                                <th class="w-24">Method</th>
                                <th class="w-24">Block</th>
                                <th class="w-24 text-blue-400">Age</th>
                                <th class="w-32">From</th>
                                <th class="w-10"></th>
                                <th class="w-32">To</th>
                                <th class="w-24">Value</th>
                                <th class="w-16">Txn Fee</th>
                            </tr>
                        </thead>
                        <tbody id="live-table-body" class="bg-[#111827]">
                            </tbody>
                    </table>
                </div>
                
                <div class="px-5 py-3 bg-gray-800/50 border-t border-gray-700 text-center">
                    <span class="text-xs text-gray-500 font-medium uppercase tracking-wider">Live Sepolia Stream</span>
                </div>
            </div>
        </div>

        <div id="view-tx" class="view-section">
            <button onclick="showHome()" class="text-blue-400 hover:text-blue-300 text-sm flex items-center gap-2 mb-4 font-medium transition">
                ← Back to Feed
                <span id="tx-back-badge" class="hidden bg-green-600 text-white text-[10px] px-2 py-0.5 rounded-full animate-pulse">0 new</span>
            </button>
            
            <div class="es-card p-0 overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-700 bg-gray-800/50">
                    <h2 class="text-lg font-medium text-white">Transaction Details</h2>
                </div>
                <div class="p-6">
                    <div class="dt-row"><div class="dt-label">Transaction Hash:</div><div class="dt-val text-white" id="det-tx-hash">-</div></div>
                    <div class="dt-row"><div class="dt-label">Status:</div><div class="dt-val" id="det-tx-status">-</div></div>
                    <div class="dt-row"><div class="dt-label">Block:</div><div class="dt-val text-blue-400" id="det-tx-block">-</div></div>
                    <div class="dt-row"><div class="dt-label">From:</div><div class="dt-val"><span class="es-link" id="det-tx-from" onclick="handleSearch(this.innerText)">-</span></div></div>
                    <div class="dt-row"><div class="dt-label">To:</div><div class="dt-val"><span class="es-link" id="det-tx-to" onclick="handleSearch(this.innerText)">-</span></div></div>
                    <div class="dt-row"><div class="dt-label">Value:</div><div class="dt-val bg-gray-800 px-3 py-1 rounded border border-gray-700 flex items-center gap-2 w-fit"><span id="det-tx-value">-</span> ETH</div></div>
                    <div class="dt-row"><div class="dt-label">Transaction Fee:</div><div class="dt-val text-gray-400" id="det-tx-fee">-</div></div>

                    <div class="mt-6 bg-blue-900/10 border border-blue-900/30 rounded p-4">
                        <h4 class="text-sm font-bold text-blue-400 mb-2 uppercase flex items-center gap-2">
                            <span class="w-2 h-2 bg-blue-500 rounded-full animate-pulse"></span> SentinETH Analysis
                        </h4>
                        <div class="grid grid-cols-2 gap-4">
                            <div><span class="text-xs text-gray-500 block">RISK SCORE</span><span class="text-lg font-bold text-white" id="det-tx-risk">-</span></div>
                            <div><span class="text-xs text-gray-500 block">RISK LEVEL</span><span class="text-lg font-bold text-white" id="det-tx-level">-</span></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-wallet" class="view-section">
            <button onclick="showHome()" class="text-blue-400 hover:text-blue-300 text-sm flex items-center gap-2 mb-4 font-medium transition">
                ← Back to Feed
                <span id="wal-back-badge" class="hidden bg-green-600 text-white text-[10px] px-2 py-0.5 rounded-full animate-pulse">0 new</span>
            </button>

            <div class="es-card p-0 overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-700 bg-gray-800/50 flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-600 to-purple-600"></div>
                    <h2 class="text-lg font-medium text-white">Address Details</h2>
                </div>
                <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="space-y-4">
                        <h3 class="text-xs font-bold text-gray-500 uppercase tracking-wide">Overview</h3>
                        <div class="bg-gray-800/50 p-4 rounded border border-gray-700">
                            <div class="text-gray-400 text-xs mb-1">ETH BALANCE</div>
                            <div class="text-xl text-white font-medium"><span id="det-wal-balance">-</span> ETH</div>
                        </div>
                        <div class="bg-gray-800/50 p-4 rounded border border-gray-700">
                            <div class="text-gray-400 text-xs mb-1">VALUE</div>
                            <div class="text-base text-gray-300" id="det-wal-usd">-</div>
                        </div>
                    </div>
                    <div class="space-y-4">
                        <h3 class="text-xs font-bold text-gray-500 uppercase tracking-wide">Details</h3>
                        <div class="flex justify-between border-b border-gray-800 py-2"><span class="text-gray-400 text-sm">Address</span><span class="text-white text-sm font-mono truncate w-40" id="det-wal-addr">-</span></div>
                        <div class="flex justify-between border-b border-gray-800 py-2"><span class="text-gray-400 text-sm">Transactions</span><span class="text-white text-sm" id="det-wal-count">-</span></div>
                        <div class="flex justify-between border-b border-gray-800 py-2"><span class="text-gray-400 text-sm">Trust Score</span><span class="text-green-400 text-sm font-bold" id="det-wal-trust">-</span></div>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <div id="loader" class="fixed inset-0 bg-black/90 z-[100] hidden flex flex-col items-center justify-center">
        <div class="w-12 h-12 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mb-4"></div>
        <div class="text-blue-400 font-mono text-sm animate-pulse">Querying Sepolia Node...</div>
    </div>

    <script>
        // --- 1. CONFIG & CACHE ---
        const ALCHEMY_WS_URL = 'wss://eth-sepolia.g.alchemy.com/v2/5bURjldvKPu4glB_tFxWt';
        const tableBody = document.getElementById('live-table-body');
        const MAX_ROWS = 20; // Rows in DOM
        const CACHE_KEY = 'sepolia_tx_cache';
        const CACHE_SIZE = 50; // Rows in SessionStorage
        
        let web3;
        let isFeedVisible = true;
        let missedUpdates = 0; // Counter for background updates

        // --- 2. INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            // A. Restore from Cache first (Instant Load)
            loadCache();

            // B. Connect to Blockchain
            if (ALCHEMY_WS_URL) {
                try {
                    web3 = new Web3(new Web3.providers.WebsocketProvider(ALCHEMY_WS_URL));
                    
                    web3.eth.subscribe('newBlockHeaders', (error, header) => {
                        if (!error) {
                            document.getElementById('connection-status').innerText = "LIVE";
                            document.getElementById('connection-status').classList.add('text-green-400');
                            fetchBlockTransactions(header.number);
                        } else {
                            document.getElementById('connection-status').innerText = "ERROR";
                            document.getElementById('connection-status').classList.add('text-red-500');
                        }
                    });
                } catch (e) { console.error(e); }
            }
        });

        // --- 3. CACHE LOGIC ---
        function loadCache() {
            const cached = sessionStorage.getItem(CACHE_KEY);
            if (cached) {
                const txs = JSON.parse(cached);
                // Clear table before restoring
                tableBody.innerHTML = '';
                txs.forEach(tx => renderRow(tx));
                console.log(`Restored ${txs.length} txs from cache.`);
            }
        }

        function saveToCache(tx) {
            let cached = JSON.parse(sessionStorage.getItem(CACHE_KEY) || "[]");
            // Add new tx to top
            cached.unshift(tx);
            // Limit cache size
            if (cached.length > CACHE_SIZE) cached = cached.slice(0, CACHE_SIZE);
            sessionStorage.setItem(CACHE_KEY, JSON.stringify(cached));
        }

        // --- 4. LIVE FEED LOGIC ---
        async function fetchBlockTransactions(blockNumber) {
            try {
                const block = await web3.eth.getBlock(blockNumber, true);
                if (block && block.transactions) {
                    // Process a few transactions to avoid UI freeze
                    block.transactions.slice(0, 3).forEach(tx => processNewTx(tx));
                }
            } catch (e) { console.error(e); }
        }

        function processNewTx(tx) {
            // 1. Prepare Data Object
            const txData = {
                hash: tx.hash,
                from: tx.from,
                to: tx.to,
                value: web3.utils.fromWei(tx.value, 'ether'),
                block: tx.blockNumber,
                input: tx.input
            };

            // 2. Save to Cache (Always)
            saveToCache(txData);

            // 3. Update UI or Counter
            if (isFeedVisible) {
                renderRow(txData);
            } else {
                missedUpdates++;
                updateBackBadges();
            }
        }

        function renderRow(tx) {
            const row = document.createElement('tr');
            row.className = 'hover:bg-gray-800/50 border-b border-gray-800 animate-flash transition-colors';
            
            const shortHash = h => `${h.substring(0, 14)}...`;
            const shortAddr = a => a ? `${a.substring(0, 8)}...${a.substring(a.length-8)}` : '-';
            const val = parseFloat(tx.value).toFixed(5);
            const method = (!tx.input || tx.input === '0x') ? 'Transfer' : 'Contract';

            row.innerHTML = `
                <td><span class="es-link font-mono text-blue-400" onclick="handleSearch('${tx.hash}')">${shortHash(tx.hash)}</span></td>
                <td><span class="bg-gray-800 border border-gray-600 text-gray-300 text-[10px] px-2 py-0.5 rounded">${method}</span></td>
                <td><span class="text-blue-400 text-sm">${tx.block}</span></td>
                <td class="text-xs text-gray-400">just now</td>
                <td><span class="es-link font-mono text-blue-400" onclick="handleSearch('${tx.from}')">${shortAddr(tx.from)}</span></td>
                <td><span class="bg-gray-800 text-green-500 border border-green-900 text-[10px] px-1 rounded font-bold">→</span></td>
                <td><span class="es-link font-mono text-blue-400" onclick="handleSearch('${tx.to}')">${shortAddr(tx.to)}</span></td>
                <td class="text-xs text-gray-300 font-mono">${val} ETH</td>
                <td class="text-xs text-gray-500 font-mono">0.00042</td>
            `;
            
            tableBody.prepend(row);
            if (tableBody.children.length > MAX_ROWS) tableBody.lastElementChild.remove();
        }

        // --- 5. SEARCH & NAVIGATION ---
        
        function switchView(id) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            
            // Logic for Feed Visibility
            if (id === 'view-feed') {
                isFeedVisible = true;
                missedUpdates = 0; // Reset counter
                updateBackBadges();
                // When showing feed again, re-render from cache to ensure gaps are filled
                loadCache(); 
            } else {
                isFeedVisible = false;
            }
        }

        function showHome() { switchView('view-feed'); }
        function showLoader(show) { document.getElementById('loader').classList.toggle('hidden', !show); }

        function updateBackBadges() {
            const badges = [document.getElementById('tx-back-badge'), document.getElementById('wal-back-badge')];
            badges.forEach(b => {
                if (missedUpdates > 0) {
                    b.classList.remove('hidden');
                    b.innerText = `${missedUpdates} new`;
                } else {
                    b.classList.add('hidden');
                }
            });
        }

        async function handleSearch(queryOverride = null) {
            const query = (queryOverride || document.getElementById('main-search').value).trim();
            if (!query) return;
            showLoader(true);

            if (query.length === 66 && query.startsWith('0x')) await loadTxDetails(query);
            else if (query.length === 42 && query.startsWith('0x')) await loadWalletDetails(query);
            else { alert("Invalid Format"); showLoader(false); }
        }

        async function loadTxDetails(hash) {
            try {
                const res = await fetch(`/api/proxy/transaction/${hash}`);
                const data = await res.json();
                if (data.error) throw new Error(data.error);

                document.getElementById('det-tx-hash').innerText = data.hash;
                document.getElementById('det-tx-status').innerHTML = data.status === 'Success' 
                    ? '<span class="text-green-400 font-bold bg-green-900/20 px-2 rounded text-xs border border-green-900">Success</span>' 
                    : '<span class="text-red-400 font-bold bg-red-900/20 px-2 rounded text-xs border border-red-900">Failed</span>';
                
                document.getElementById('det-tx-block').innerText = data.block;
                document.getElementById('det-tx-from').innerText = data.from;
                document.getElementById('det-tx-to').innerText = data.to;
                document.getElementById('det-tx-value').innerText = data.value.toFixed(6);
                document.getElementById('det-tx-fee').innerText = data.fee.toFixed(6) + " ETH";
                
                const risk = data.risk_score;
                if (risk !== null) {
                    const color = risk > 7 ? 'text-red-500' : (risk > 4 ? 'text-yellow-500' : 'text-green-500');
                    document.getElementById('det-tx-risk').innerHTML = `<span class="${color}">${risk}/10</span>`;
                    document.getElementById('det-tx-level').innerText = data.risk_level;
                } else {
                    document.getElementById('det-tx-risk').innerText = "Not Analyzed";
                    document.getElementById('det-tx-level').innerText = "-";
                }

                switchView('view-tx');
            } catch (e) { alert(e.message); } 
            finally { showLoader(false); }
        }

        async function loadWalletDetails(addr) {
            try {
                const res = await fetch(`/api/proxy/wallet/${addr}`);
                const data = await res.json();
                if (data.error) throw new Error(data.error);

                document.getElementById('det-wal-addr').innerText = data.address;
                document.getElementById('det-wal-balance').innerText = data.balance.toFixed(5);
                document.getElementById('det-wal-usd').innerText = `$${(data.balance * 3600).toFixed(2)}`;
                document.getElementById('det-wal-count').innerText = data.tx_count;
                
                const trust = data.trust_score;
                document.getElementById('det-wal-trust').innerText = trust ? (trust * 100).toFixed(0) : "N/A";

                switchView('view-wallet');
            } catch (e) { alert(e.message); } 
            finally { showLoader(false); }
        }
    </script>
</body>
</html>